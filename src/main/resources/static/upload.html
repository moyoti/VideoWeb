<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <!-- 新 Bootstrap 核心 CSS 文件 -->
    <link href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">

    <!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
    <script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>

    <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
    <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script>
        $(function () {
            $("#btn").on('click', function () {
                UploadFile();
            });

            $("#file").change(function () {
                $("#progress-bar").css("width", 0);
            });

            // ajax + jQuery上传
            function UploadFile() {
                var xhrOnProgress = function (fun) {
                    xhrOnProgress.onprogress = fun; //绑定监听
                    //使用闭包实现监听绑
                    return function () {
                        //通过$.ajaxSettings.xhr();获得XMLHttpRequest对象
                        var xhr = $.ajaxSettings.xhr();
                        //判断监听函数是否为函数
                        if (typeof xhrOnProgress.onprogress !== 'function')
                            return xhr;
                        //如果有监听函数并且xhr对象支持绑定时就把监听函数绑定上去
                        if (xhrOnProgress.onprogress && xhr.upload) {
                            xhr.upload.onprogress = xhrOnProgress.onprogress;
                        }
                        return xhr;
                    }
                };

                var file = $("#file")[0].files[0];
                var videotitle=$("#videoname").val();
                var form = new FormData();
                form.append('myfile', file);
                form.append('title',videotitle);
                form.append("csrfmiddlewaretoken", '{{ csrf_token }}');
                $.ajax({
                    type: 'POST',
                    url: '/video/upload',
                    data: form,
                    processData: false,  // 告诉jquery不转换数据
                    contentType: false,  // 告诉jquery不设置内容格式
                    xhr: xhrOnProgress(function (e) {
                        var percent = e.loaded / e.total;
                        $("#progress-bar").css("width", (percent * 500));
                        document.getElementById("sr-only").innerText=parseInt((percent*100).toString())+"%";
                    }),

                    success: function (arg) {
                        console.log(arg);
                    }
                })
            }
        });
        $(document).ready(function () {
            var tbody;
            $.ajax({
                type: "POST",
                url: "/users/loginstats",
                data: {},
                success:function (result) {
                    userHeadPic=result[3];
                    if (result[0] == 1) {
                        $("#userCommentPic").attr("src","http://localhost:8081/pic/" + result[3]);
                        tbody = "";
                        tbody = "<li><img class=\"img-circle\" src=\"http://localhost:8081/pic/"+result[3]+"\"\n" +
                            "                         style=\"height: 38px;width:38px;margin-top: 6px\"></li>\n" +
                            "                <li><a href=\"#\">" + result[1] + "</a></li>"
                            + "<li><a onclick='logout()'><span class=\"glyphicon glyphicon-log-out\"></span>注销</a></li>";
                        document.getElementById("usershow").innerHTML += tbody;
                    } else {
                        tbody = "<li><a href=\"signup.html\"><span class=\"glyphicon glyphicon-user\"></span> 注册</a></li>\n" +
                            "                <li><a href=\"login.html\"><span class=\"glyphicon glyphicon-log-in\"></span> 登录</a></li>";
                        document.getElementById("usershow").innerHTML += tbody;
                    }
                }
            });

        });
    </script>
</head>
<body>
<div class="navbar navbar-inverse visible-lg visible-md navbar-fixed-top navbar-hidden" role="navigation"
     style="top: 0px;">
    <div class="container">

        <div class="navbar-header">
            <a class="navbar-brand" href="homepage.html">首页</a>
        </div>
        <div>
            <ul class="nav navbar-nav">
                <li class="active"><a href="#">链接1</a></li>
                <li><a href="#">链接2</a></li>
                <li><a href="#" class="dropdown-toggle" data-toggle="dropdown">链接3</a></li>

            </ul>
            <ul id="usershow" class="nav navbar-nav navbar-right">
                <!--登录时-->
                <!--<li><img class="img-circle" src="http://localhost:8081/pic/20151101201716.jpg"-->
                <!--style="height: 38px;width:38px;margin-top: 6px"></li>-->
                <!--<li><a href="#">username</a></li>-->
                <!--未登录时-->
                <!--<li><a href="#"><span class="glyphicon glyphicon-user"></span> 注册</a></li>-->
                <!--<li><a href="#"><span class="glyphicon glyphicon-log-in"></span> 登录</a></li>-->
            </ul>
        </div>
    </div>
</div>
<div class="container" style="margin-top: 15%">
    <div class="row">
        <div class="col-md-5 col-md-offset-4">
            <form action="/video/upload" enctype="multipart/form-data" method="POST">
                <input type="text" id="videoname"/>
                <input type="file" id="file"/>
                <button id="btn">上传</button>
            </form>
            <div class="progress" style="width: 500px">
                <div id="progress-bar" class="progress-bar progress-bar-success progress-bar-striped" role="progressbar"
                     aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                    <span id="sr-only" style="z-index: 10"></span>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>